<!DOCTYPE html>
<html><head>
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

   
    <meta name="author" content="jxsrlsl1234">
  

   
    
    
    
    
    
    
    <meta name="keywords" content="theme,kagome">
  

  

  <meta name="generator" content="Hugo 0.87.0" />
  
  
  
  
  
  
  <title>SpringBooté¡¹ç›®åœ¨JVMé€€å‡ºæ—¶æ—¥å¿—ä¸¢å¤±æƒ…å†µåˆ†æ ğŸŒŸ éæ´²å¤§ç™½è„¸</title>

  <meta property="og:title" content="SpringBooté¡¹ç›®åœ¨JVMé€€å‡ºæ—¶æ—¥å¿—ä¸¢å¤±æƒ…å†µåˆ†æ" />
<meta property="og:description" content="é—®é¢˜èƒŒæ™¯ SpringBootæ¡†æ¶åœ¨å¯åŠ¨æ—¶ä¸ºSpringContextæ³¨å†Œäº†ä¸€ä¸ªShutdownHookæ¥å…³é—­SpringContextï¼Œè€ŒJ" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://jxsrlsl1234.github.io/blogs/springboot%E9%A1%B9%E7%9B%AE%E5%9C%A8jvm%E9%80%80%E5%87%BA%E6%97%B6%E6%97%A5%E5%BF%97%E4%B8%A2%E5%A4%B1%E6%83%85%E5%86%B5%E5%88%86%E6%9E%90/" /><meta property="article:section" content="blogs" />
<meta property="article:published_time" content="2022-12-22T15:50:53+08:00" />
<meta property="article:modified_time" content="2022-12-22T15:50:53+08:00" />


  <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="SpringBooté¡¹ç›®åœ¨JVMé€€å‡ºæ—¶æ—¥å¿—ä¸¢å¤±æƒ…å†µåˆ†æ"/>
<meta name="twitter:description" content="é—®é¢˜èƒŒæ™¯ SpringBootæ¡†æ¶åœ¨å¯åŠ¨æ—¶ä¸ºSpringContextæ³¨å†Œäº†ä¸€ä¸ªShutdownHookæ¥å…³é—­SpringContextï¼Œè€ŒJ"/>


  
  
  
  
  <link rel="stylesheet" href="https://jxsrlsl1234.github.io/assets/css/style.min.699f46622e3574a7f9ecca4c5877067845fe89ffcd9c4335df2dff23ddae215e.css" integrity="sha256-aZ9GYi41dKf57MpMWHcGeEX&#43;if/NnEM13y3/I92uIV4=">

  <script src="https://jxsrlsl1234.github.io/assets/js/main.min.182da266209851bc7c828aa7377f98f914e1e76c8decdd53a6cbe9bffea92cde.js" integrity="sha256-GC2iZiCYUbx8goqnN3&#43;Y&#43;RTh52yN7N1Tpsvpv/6pLN4="></script>
  
  </head><body><header class="header-container layout-block layout-padding">
  <div class="header-inner content-padding-large soft-size--large soft-style--box">
    <div class="header-logo">
      <a href="https://jxsrlsl1234.github.io/"><h1>éæ´²å¤§ç™½è„¸</h1></a>
    </div>
    <nav class="header-nav">
      <div class="header-nav--btn">
        <div class="btn-item"></div>
        <div class="btn-item"></div>
        <div class="btn-item"></div>
      </div>
      <div class="header-nav--list">
        <div>
          
          <a class="list-item soft-size--small soft-style--hover soft-style--active" href="/" title="">HOME</a>
          
          <a class="list-item soft-size--small soft-style--hover soft-style--active" href="/blogs" title="">BLOG</a>
          
        </div>
      </div>
    </nav>
  </div>
</header><main id="content">
    

    <div class="single-container layout-block">
      <div class="article-info">
        <div class="article-header layout-padding">
          <div class="article-cover card-container content-padding-large soft-size--large soft-style--box img">

  <div class="card-cover">
    
      <img src="https://raw.githubusercontent.com/jxsrlsl1234/public-images/master/blogs/cover1.png" alt="https://raw.githubusercontent.com/jxsrlsl1234/public-images/master/blogs/cover1.png" />
    
  </div>

  <div class="card-text">
    <h1 class="card-text--title">SpringBooté¡¹ç›®åœ¨JVMé€€å‡ºæ—¶æ—¥å¿—ä¸¢å¤±æƒ…å†µåˆ†æ</h1>
    
      <p class="card-text--row">2022-12-22 15:50</p>
      
      
      
        <ul class="card-text--tag">
          
            <li><a href="https://jxsrlsl1234.github.io/categories/java/">Java</a></li></ul>
      

      
      
        <ul class="card-text--tag">
          
            <li><a href="https://jxsrlsl1234.github.io/tags/springboot/">SpringBoot</a></li>
            <li><a href="https://jxsrlsl1234.github.io/tags/jvm/">JVM</a></li>
            <li><a href="https://jxsrlsl1234.github.io/tags/sentinel/">Sentinel</a></li>
            <li><a href="https://jxsrlsl1234.github.io/tags/%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6/">æ—¥å¿—æ¡†æ¶</a></li></ul>
      
    
  </div>

</div>
        </div>

        <div class="article-content">
          <div class="markdown-body content-padding-large soft-size--large soft-style--box">
            <h2 id="é—®é¢˜èƒŒæ™¯">é—®é¢˜èƒŒæ™¯</h2>
<p>SpringBootæ¡†æ¶åœ¨å¯åŠ¨æ—¶ä¸ºSpringContextæ³¨å†Œäº†ä¸€ä¸ªShutdownHookæ¥å…³é—­SpringContextï¼Œè€ŒJULæ—¥å¿—æ¡†æ¶ä¹Ÿæ³¨å†Œäº†ä¸€ä¸ªShutdownHookæ¥å…³é—­JULç›¸å…³æ—¥å¿—å†…å®¹ï¼Œä¸”ShutdownHookæ˜¯å¹¶è¡Œæ‰§è¡Œçš„ã€‚
åœ¨SpringBootæ¥å—åˆ°TERMä¿¡å·å‡†å¤‡é€€å‡ºæ—¶ï¼Œä¼šæ‰§è¡ŒShutDownHookçš„é’©å­å‡½æ•°ï¼Œå¹¶è¡Œæ‰§è¡Œæ‰€æœ‰çš„Shutdowné€»è¾‘ï¼Œå…·ä½“ä»£ç åœ¨ï¼š
<strong>java.lang.ApplicationShutdownHooks#runHooks</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">/* Iterates over all application hooks creating a new thread for each
</span><span style="color:#75715e"> * to run in. Hooks are run concurrently and this method waits for
</span><span style="color:#75715e"> * them to finish.
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">runHooks</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  Collection<span style="color:#f92672">&lt;</span>Thread<span style="color:#f92672">&gt;</span> threads<span style="color:#f92672">;</span>
  <span style="color:#66d9ef">synchronized</span><span style="color:#f92672">(</span>ApplicationShutdownHooks<span style="color:#f92672">.</span><span style="color:#a6e22e">class</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    threads <span style="color:#f92672">=</span> hooks<span style="color:#f92672">.</span><span style="color:#a6e22e">keySet</span><span style="color:#f92672">();</span>
    hooks <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>

  <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Thread hook <span style="color:#f92672">:</span> threads<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//å¹¶è¡Œæ‰§è¡Œ
</span><span style="color:#75715e"></span>    hook<span style="color:#f92672">.</span><span style="color:#a6e22e">start</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Thread hook <span style="color:#f92672">:</span> threads<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">true</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        hook<span style="color:#f92672">.</span><span style="color:#a6e22e">join</span><span style="color:#f92672">();</span>
        <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedException ignored<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>åŒæ—¶ï¼ŒSpringBootæœ¬èº«ä¹Ÿæœ‰å…¶ä»–çš„æ—¥å¿—ç³»ç»Ÿï¼Œæ¯”å¦‚è¯´Logbackï¼Œä¸”ç›¸å…³çš„é€€å‡ºé€»è¾‘æ˜¯é ç›‘å¬Springçš„ContextClosedEventäº‹ä»¶ä»è€Œé€€å‡ºçš„ã€‚æ³¨æ„SpringBootä¸­æ‰€æœ‰çš„ç›‘å¬å™¨çš„æ‰§è¡Œéƒ½æ˜¯åŒæ­¥çš„ã€‚</p>
<p>å› æ­¤æ‰€æœ‰çš„æ‰§è¡Œé€»è¾‘é¡ºåºå¦‚ä¸‹ï¼š

  <p><img src="https://raw.githubusercontent.com/jxsrlsl1234/public-images/master/blogs/JVMexit.png" alt="" loading="lazy" /></p>
</p>
<p>æˆ‘ä»¬åªé’ˆå¯¹æ§åˆ¶å°æ‰“æ—¥å¿—æ¥åˆ†æã€‚ <br>
é—®é¢˜å…³é”®åœ¨çº¢è‰²éƒ¨åˆ†æŒ‰ç†ç¬¬ä¸€å—çš„ç›‘å¬å™¨æ‰“å‡ºæ¥çš„æ—¥å¿—æ˜¯å¯ä»¥çœ‹åˆ°çš„ï¼ˆå› ä¸ºæ­¤æ—¶LoggingApplicationListenerè¿˜æ²¡æœ‰å¼€å§‹æ¸…ç†æ—¥å¿—ç³»ç»Ÿï¼‰ï¼Œä½†æ˜¯æµ‹è¯•æ˜¯å‘ç°æœ‰æ—¶å€™çœ‹ä¸åˆ°ã€‚</p>
<h2 id="åŸå› åˆ†æ">åŸå› åˆ†æ</h2>
<h3 id="21-æ ¹æœ¬åŸå› è¾“å‡ºæµè¢«æå‰å…³é—­">2.1 æ ¹æœ¬åŸå› ï¼Œè¾“å‡ºæµè¢«æå‰å…³é—­</h3>
<p>æ—¥å¿—æ§åˆ¶å°è¾“å‡ºé‡‡ç”¨çš„æ˜¯ConsoleAppender,è¿™ä¸ªæ˜¯ä¸ªæ—¥å¿—è¾“å‡ºæ˜¯åŒæ­¥çš„ã€‚<br>
log.info(xxx)æœ€ç»ˆå¾€ConsoleAppenderè¾“å‡ºï¼Œè°ƒç”¨çš„æ˜¯è¿™ä¸ªï¼š <br>
<strong>ch.qos.logback.core.joran.spi.ConsoleTargetï¼ˆæ˜¯logbackçš„ï¼‰</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">enum</span> ConsoleTarget <span style="color:#f92672">{</span>
  SystemOut<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;System.out&#34;</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">new</span> OutputStream<span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> b<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>b<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> b<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
      <span style="color:#75715e">// æ˜¯Systemç±»ä¸­çš„ä¸€ä¸ªstatic finalå˜é‡out[PrintStreamç±»å‹]
</span><span style="color:#75715e"></span>      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>b<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#66d9ef">byte</span><span style="color:#f92672">[]</span> b<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> off<span style="color:#f92672">,</span> <span style="color:#66d9ef">int</span> len<span style="color:#f92672">)</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>b<span style="color:#f92672">,</span> off<span style="color:#f92672">,</span> len<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">flush</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
      System<span style="color:#f92672">.</span><span style="color:#a6e22e">out</span><span style="color:#f92672">.</span><span style="color:#a6e22e">flush</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}),</span>
</code></pre></div><p><strong>java.io.PrintStream#write(int)</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> b<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">//è¦ç¡®ä¿outè¿™ä¸ªOutStreamä¸ä¸ºç©º
</span><span style="color:#75715e"></span>      ensureOpen<span style="color:#f92672">();</span>
      out<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>b<span style="color:#f92672">);</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">((</span>b <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span><span style="color:#f92672">)</span> <span style="color:#f92672">&amp;&amp;</span> autoFlush<span style="color:#f92672">)</span>
        out<span style="color:#f92672">.</span><span style="color:#a6e22e">flush</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedIOException x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">//å¼‚å¸¸è¢«åäº†
</span><span style="color:#75715e"></span>    trouble <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ensureOpen</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>out <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IOException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Stream closed&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ä½†æ˜¯å¯¹æœªè¾“å‡ºæ—¥å¿—çš„log debugå‘ç°ensureOpenæ–¹æ³•é‡Œæ‰§è¡Œæ—¶outä¸ºnullï¼Œä¹Ÿå°±æ˜¯è¯´æ˜è¿™ä¸ªè¾“å‡ºæµè¢«å…¶ä»–æ–¹å¼å…³é—­äº†ã€‚
è¿™ä¸ªoutä¸æ˜¯æŒ‡System.outè¿™ä¸ªPrintStreamï¼Œè€Œæ˜¯System.outè¿™ä¸ªPrintStreamå†…éƒ¨ä¿å­˜çš„ä¸€ä¸ªOutputStreamï¼Œä»FilterOutputStreamé‡Œç»§æ‰¿ä¸‹æ¥çš„ã€‚  <br>
è€Œè¿™ä¸ªoutå…³é—­çš„æ–¹æ³•ä¸ºä»¥ä¸‹æ–¹å¼ï¼š  <br>
<strong>java.io.PrintStream#close</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(!</span> closing<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      closing <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
      <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
        textOut<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
        out<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
      <span style="color:#f92672">}</span>
      <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        trouble <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
      textOut <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
      charOut <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
      <span style="color:#75715e">// outè¢«ç½®ç©ºäº†
</span><span style="color:#75715e"></span>      out <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å› æ­¤æˆ‘ä»¬åªéœ€è¦æ‰¾åˆ°æ˜¯ä»€ä¹ˆé€»è¾‘æå‰è°ƒç”¨äº†è¿™æ®µæ–¹æ³•å³å¯ã€‚</p>
<h3 id="22-è°æå‰å…³é—­äº†è¾“å‡ºæµ">2.2 è°æå‰å…³é—­äº†è¾“å‡ºæµï¼Ÿ</h3>
<p>å…ˆè¯´ç»“è®ºï¼šé€šè¿‡debugå‘ç°ï¼Œæ˜¯jdkåœ¨ShudownHooké˜¶æ®µæ¸…ç†JULæ—¥å¿—ç›¸å…³å†…å®¹æ—¶ç›´æ¥å…³é—­äº†è¾“å‡ºæµï¼Œä½†æ˜¯<strong>ä¸æ˜¯JULçš„é—®é¢˜ï¼Œæ˜¯Sentinelçš„é—®é¢˜</strong>ã€‚</p>
<hr>
<p>è¿™é‡Œå…ˆè¯´ä¸ªæ¦‚å¿µï¼š <br>
JULå’ŒSentineléƒ½å®šä¹‰äº†ConsoleHandlerï¼Œå¯ä»¥ç†è§£æ˜¯å°†æ—¥å¿—è®°å½•è¿›è¡Œå¤„ç†çš„ä¸€ä¸ªå¤„ç†å™¨ï¼Œä¸”éƒ½ç»§æ‰¿äº†JULæä¾›çš„ java.util.logging.Handler ç±»ï¼Œã€‚ä½†æ˜¯è¿™ä¸¤ä¸ªhandlerçš„closeæ“ä½œæ˜¯å®Œå…¨ä¸ä¸€æ ·çš„ã€‚</p>
<p>JULï¼Œä»…ä»…æ˜¯flushæ“ä½œ</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
  flush<span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>Sentinelï¼Œå¤ªå¯æ¶äº†ï¼ŒæŠŠstdoutåŠstderrè¾“å‡ºæµç»™å…³é—­äº†ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> SecurityException <span style="color:#f92672">{</span>
  stdoutHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
  stderrHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼šå¦‚æœcloseæ“ä½œæŠŠè¾“å‡ºæµå…³é—­äº†ï¼Œé‚£ä¹ˆæ§åˆ¶å°å†ä¹Ÿæ— æ³•æ‰“å°å‡ºæ—¥å¿—ï¼ŒåŒæ—¶ï¼Œä¹Ÿä¸ä¼šæŠ¥é”™ï¼Œå› ä¸ºSystem.outè¿™ä¸ªPrintStreamé»˜è®¤ä¼šæŠŠå¼‚å¸¸ç»™åäº†ã€‚</p>
<hr>
<p>æ¥ä¸‹æ¥å¼€å§‹åˆ†æï¼Œæ˜¯è°åœ¨ä½•æ—¶æŠŠè¿™ä¸ªè¾“å‡ºæµç»™å…³é—­äº†ï¼Œæˆ‘ä»¬æŒ‰ç…§æ‰§è¡Œæµç¨‹æ¥çœ‹ã€‚</p>
<h4 id="221-julæ‰§è¡Œshutdownhookæ¸…ç†æ“ä½œ">2.2.1 JULæ‰§è¡ŒShutdownHookæ¸…ç†æ“ä½œ</h4>
<p><strong>java.util.logging.LogManager.Cleaner</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//è¿™ä¸ªå°±æ˜¯shutdownHookæ‰§è¡Œçš„å†…å®¹
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">Cleaner</span> <span style="color:#66d9ef">extends</span> Thread <span style="color:#f92672">{</span>

  <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">Cleaner</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">super</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Logging-Cleaner&#34;</span><span style="color:#f92672">,</span> 0<span style="color:#f92672">,</span> <span style="color:#66d9ef">false</span><span style="color:#f92672">);</span>
    <span style="color:#75715e">/* Set context class loader to null in order to avoid
</span><span style="color:#75715e">             * keeping a strong reference to an application classloader.
</span><span style="color:#75715e">             */</span>
    <span style="color:#66d9ef">this</span><span style="color:#f92672">.</span><span style="color:#a6e22e">setContextClassLoader</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>

  <span style="color:#a6e22e">@Override</span>
  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">run</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// This is to ensure the LogManager.&lt;clinit&gt; is completed
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// before synchronized block. Otherwise deadlocks are possible.
</span><span style="color:#75715e"></span>    LogManager mgr <span style="color:#f92672">=</span> manager<span style="color:#f92672">;</span>

    <span style="color:#75715e">// set globalHandlersState to STATE_SHUTDOWN atomically so that
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// no attempts are made to (re)initialize the handlers or (re)read
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// the configuration again. This is terminal state.
</span><span style="color:#75715e"></span>    configurationLock<span style="color:#f92672">.</span><span style="color:#a6e22e">lock</span><span style="color:#f92672">();</span>
    globalHandlersState <span style="color:#f92672">=</span> STATE_SHUTDOWN<span style="color:#f92672">;</span>
    configurationLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>

    <span style="color:#75715e">// Do a reset to close all active handlers.
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// è¿™é‡Œæ˜¯æ‰§è¡Œæ¸…ç†é€»è¾‘
</span><span style="color:#75715e"></span>    reset<span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="222-è§¦å‘å¯¹julçš„loggercontextçš„æ¸…ç†">2.2.2 è§¦å‘å¯¹JULçš„LoggerContextçš„æ¸…ç†</h4>
<p><strong>java.util.logging.LogManager#reset</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">reset</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> SecurityException <span style="color:#f92672">{</span>
 	<span style="color:#f92672">...</span>
  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
		<span style="color:#f92672">...</span>
    <span style="color:#75715e">// contexts()æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯SystemLoggerContextï¼Œä¸€ä¸ªæ˜¯UserLoggerContext
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>LoggerContext cx <span style="color:#f92672">:</span> contexts<span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// æ¸…ç†é€»è¾‘åœ¨è¿™
</span><span style="color:#75715e"></span>      resetLoggerContext<span style="color:#f92672">(</span>cx<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>

    persistent<span style="color:#f92672">.</span><span style="color:#a6e22e">clear</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span> <span style="color:#66d9ef">finally</span> <span style="color:#f92672">{</span>
    configurationLock<span style="color:#f92672">.</span><span style="color:#a6e22e">unlock</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>æ˜¯åœ¨æ‰§è¡ŒUserLoggerContextçš„restæ—¶è¢«æ¸…ç†çš„ï¼ŒSystemLoggerContextä¿å­˜çš„æ˜¯å’Œjdkæœ¬èº«ç›¸å…³çš„ä¸€äº›loggerï¼Œ
UserLoggerContextä¿å­˜äº†å’Œä¸šåŠ¡é…ç½®ç›¸å…³çš„ä¸€äº›loggerï¼ˆ<!-- raw HTML omitted -->æ¯”å¦‚ä¸šåŠ¡ç›´æ¥ä½¿ç”¨JULæ¡†æ¶getLoggerï¼Œæˆ–è€…logbcaké…ç½®çš„ï¼Œä¸ºå•¥logbacké…ç½®çš„å†…å®¹ä¼šåœ¨jdké‡Œå­˜ï¼Œè¿™ä¸ªåé¢å†è¯´<!-- raw HTML omitted -->ï¼‰ã€‚</p>
<h4 id="223-é‡ç½®æ¯ä¸€ä¸ªloggercontextä¸­logger">2.2.3 é‡ç½®æ¯ä¸€ä¸ªLoggerContextä¸­Logger</h4>
<p><strong>java.util.logging.LogManager#resetLoggerContext</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">//è¿™ä¸ªæ–¹æ³•æ˜¯è¯´ä¼šè·å–è¿™ä¸ªloggerContexté‡Œçš„æ‰€æœ‰Loggerï¼Œç„¶ååªè¦æ‰¾åˆ°å°±ä¼šå»reset
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">resetLoggerContext</span><span style="color:#f92672">(</span>LoggerContext cx<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">//è·å–userLoggerContexté‡Œçš„æ‰€æœ‰loggerNameï¼Œç„¶åéå†å¼€å§‹
</span><span style="color:#75715e"></span>  Enumeration<span style="color:#f92672">&lt;</span>String<span style="color:#f92672">&gt;</span> enum_ <span style="color:#f92672">=</span> cx<span style="color:#f92672">.</span><span style="color:#a6e22e">getLoggerNames</span><span style="color:#f92672">();</span>
  <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>enum_<span style="color:#f92672">.</span><span style="color:#a6e22e">hasMoreElements</span><span style="color:#f92672">())</span> <span style="color:#f92672">{</span>
    String name <span style="color:#f92672">=</span> enum_<span style="color:#f92672">.</span><span style="color:#a6e22e">nextElement</span><span style="color:#f92672">();</span>
    Logger logger <span style="color:#f92672">=</span> cx<span style="color:#f92672">.</span><span style="color:#a6e22e">findLogger</span><span style="color:#f92672">(</span>name<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>logger <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">//è¿™é‡Œæ˜¯å…³é”®
</span><span style="color:#75715e"></span>      resetLogger<span style="color:#f92672">(</span>logger<span style="color:#f92672">);</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸Šè¿°è·å–åˆ°çš„LoggerNameå¦‚ä¸‹ï¼š

  <p><img src="https://raw.githubusercontent.com/jxsrlsl1234/public-images/master/blogs/userLoggerContext.png" alt="" loading="lazy" /></p>
</p>
<h4 id="224-å…³é—­loggerå¯¹åº”çš„æ‰€æœ‰çš„handler">2.2.4 å…³é—­Loggerå¯¹åº”çš„æ‰€æœ‰çš„Handler</h4>
<p><strong>java.util.logging.LogManager</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#75715e">// Private method to reset an individual target logger.
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">resetLogger</span><span style="color:#f92672">(</span>Logger logger<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">// Close all the Logger handlers.
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// è¿™é‡Œæ˜¯å…³é”®ï¼Œä¼šå…³é—­loggerå¯¹åº”çš„æ‰€æœ‰Handlerï¼Œå…¶ä¸­å°±åŒ…æ‹¬cspSentinelRecording Loggerçš„ConsoleHandler
</span><span style="color:#75715e"></span>  closeHandlers<span style="color:#f92672">(</span>logger<span style="color:#f92672">);</span>

  <span style="color:#75715e">// Reset Logger level
</span><span style="color:#75715e"></span>  String name <span style="color:#f92672">=</span> logger<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">();</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>name <span style="color:#f92672">!=</span> <span style="color:#66d9ef">null</span> <span style="color:#f92672">&amp;&amp;</span> name<span style="color:#f92672">.</span><span style="color:#a6e22e">equals</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;&#34;</span><span style="color:#f92672">))</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">// This is the root logger.
</span><span style="color:#75715e"></span>    logger<span style="color:#f92672">.</span><span style="color:#a6e22e">setLevel</span><span style="color:#f92672">(</span>defaultLevel<span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span> <span style="color:#66d9ef">else</span> <span style="color:#f92672">{</span>
    logger<span style="color:#f92672">.</span><span style="color:#a6e22e">setLevel</span><span style="color:#f92672">(</span><span style="color:#66d9ef">null</span><span style="color:#f92672">);</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">closeHandlers</span><span style="color:#f92672">(</span>Logger logger<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  Handler<span style="color:#f92672">[]</span> targets <span style="color:#f92672">=</span> logger<span style="color:#f92672">.</span><span style="color:#a6e22e">getHandlers</span><span style="color:#f92672">();</span>
  <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span>Handler h <span style="color:#f92672">:</span> targets<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    logger<span style="color:#f92672">.</span><span style="color:#a6e22e">removeHandler</span><span style="color:#f92672">(</span>h<span style="color:#f92672">);</span>
    <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// æ¯”å¦‚æ˜¯cspSentinelRecording Loggerçš„ConsoleHandler
</span><span style="color:#75715e"></span>      h<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Exception ex<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// Problems closing a handler?  Keep going...
</span><span style="color:#75715e"></span>    <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>Error e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">// ignore Errors while shutting down
</span><span style="color:#75715e"></span>      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>globalHandlersState <span style="color:#f92672">!=</span> STATE_SHUTDOWN<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">throw</span> e<span style="color:#f92672">;</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h4 id="225-ç½ªé­ç¥¸é¦–sentinelçš„consolehandlerçš„closeæ“ä½œå…³é—­äº†è¾“å‡ºæµ">2.2.5 ç½ªé­ç¥¸é¦–ï¼šsentinelçš„ConsoleHandlerçš„closeæ“ä½œå…³é—­äº†è¾“å‡ºæµ</h4>
<p><strong>com.alibaba.csp.sentinel.log.ConsoleHandler#close</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#a6e22e">@Override</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">close</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> SecurityException <span style="color:#f92672">{</span>
  stdoutHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
  stderrHandler<span style="color:#f92672">.</span><span style="color:#a6e22e">close</span><span style="color:#f92672">();</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ä¸Šé¢è¯´åˆ°äº†cspSentinelRecordLogï¼Œè¿™ä¸ªloggerNameå¯¹é¥®çš„Loggerè·å–åˆ°çš„Handlerå°±æœ‰ConsoleHandlerï¼Œå…¶å†…éƒ¨çš„outputå°±æ˜¯System.out

  <p><img src="https://raw.githubusercontent.com/jxsrlsl1234/public-images/master/blogs/Sentinel_ConsoleHandler.png" alt="" loading="lazy" /></p>

ç„¶åSystem.outè¿™ä¸ªPrintStreamå†…çš„ä¸€ä¸ªoutè¾“å‡ºæµå°±åœ¨stdoutHandler.close()çš„å†…éƒ¨é€»è¾‘ä¸­è¢«å…³äº†ã€‚éšåï¼Œé‚£äº›è°ƒç”¨logger.xxxæ‰“å°æ—¥å¿—çš„å†…å®¹å°†åœ¨æ§åˆ¶å°å…¨éƒ¨ä¸å¯è§ã€‚
å› ä¸ºè¿™ä¸ªæ˜¯æ§åˆ¶å°è¾“å‡ºï¼Œä¸”ä½äºè¿›ç¨‹é€€å‡ºæ—¶ï¼Œå› æ­¤æ²¡æœ‰äººä¼šå‘ç°è¿™ä¸ªé—®é¢˜ã€‚</p>
<h2 id="ä¸‰å…¶ä»–é—®é¢˜åŠåˆ†æ">ä¸‰ã€å…¶ä»–é—®é¢˜åŠåˆ†æ</h2>
<h3 id="systemç±»ä¸­çš„outå˜é‡é»˜è®¤èµ‹å€¼ä¸ºnullä¸”æ˜¯static-finalçš„ä¸ºä½•åç»­è°ƒç”¨éé™æ€æ–¹æ³•å¦‚systemoutprintxxxä¸ä¼šæŠ¥npe">Systemç±»ä¸­çš„outå˜é‡é»˜è®¤èµ‹å€¼ä¸ºnullï¼Œä¸”æ˜¯static finalçš„ï¼Œä¸ºä½•åç»­è°ƒç”¨éé™æ€æ–¹æ³•å¦‚System.out.print(&ldquo;xxx&rdquo;)ä¸ä¼šæŠ¥NPEï¼Ÿ</h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">final</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">System</span> <span style="color:#f92672">{</span>
    <span style="color:#75715e">/* Register the natives via the static initializer.
</span><span style="color:#75715e">     *
</span><span style="color:#75715e">     * VM will invoke the initializeSystemClass method to complete
</span><span style="color:#75715e">     * the initialization for this class separated from clinit.
</span><span style="color:#75715e">     * Note that to use properties set by the VM, see the constraints
</span><span style="color:#75715e">     * described in the initializeSystemClass method.
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">native</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">registerNatives</span><span style="color:#f92672">();</span>
    <span style="color:#66d9ef">static</span> <span style="color:#f92672">{</span>
        registerNatives<span style="color:#f92672">();</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/** Don&#39;t let anyone instantiate this class */</span>
    <span style="color:#66d9ef">private</span> <span style="color:#a6e22e">System</span><span style="color:#f92672">()</span> <span style="color:#f92672">{</span>
    <span style="color:#f92672">}</span>

    <span style="color:#75715e">/**
</span><span style="color:#75715e">     * The &#34;standard&#34; output stream. This stream is already
</span><span style="color:#75715e">     * open and ready to accept output data. Typically this stream
</span><span style="color:#75715e">     * corresponds to display output or another output destination
</span><span style="color:#75715e">     * specified by the host environment or user.
</span><span style="color:#75715e">     * &lt;p&gt;
</span><span style="color:#75715e">     */</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">final</span> PrintStream out <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
</code></pre></div><p>å…³é”®æ˜¯ä¸Šé¢çš„é™æ€ä»£ç å—è°ƒç”¨äº†é™æ€æ–¹æ³•registerNatives()ï¼›è¿™ä¸ªæ˜¯nativeçš„ï¼ŒçœŸå®æ‰§è¡Œä¸ºc++çš„åŠ¨æ€é“¾æ¥åº“ä»£ç ï¼Œä¹Ÿå°±æ˜¯è¯´classåœ¨åŠ è½½æ—¶è¿™æ®µä»£ç åº”è¯¥ä¼šå…ˆè¡Œæ‰§è¡Œé™æ€æ–¹æ³•registerNativesï¼Œ
è¿™é‡Œè¾¹ä¸€å®šæœ‰å¯¹outå˜é‡é‡æ–°èµ‹å€¼çš„æ“ä½œã€‚å¦å¤–ï¼Œoutè¿™ä¸ªå› ä¸ºæ˜¯static finalçš„ï¼Œåç»­ä¹Ÿä¸å¯èƒ½å†å˜ä¸ºnulläº†ã€‚å¦‚æœå†ç»§ç»­ç»†ç©¶ï¼ŒSystem.outå˜é‡æ˜¯ä¸€ä¸ªPrintStreamï¼Œ
å…¶å†…éƒ¨ä¹Ÿä¿å­˜äº†ä¸€ä¸ªoutï¼ˆä¹Ÿæ˜¯ä¸ªOutPutStreamï¼‰ï¼Œè¿™ä¸ªoutå¦‚æœä¸ºnullåï¼Œä¹Ÿä¸ä¼šæœ‰NPEï¼ŒåŸå› æ˜¯åˆ¤æ–­outä¸ºnullåæŠ›ä¸€ä¸ªIOExceptionï¼Œä½†IOExceptionä¼šè¢«åï¼Œå› æ­¤ä¹Ÿä¸ä¼šæœ‰NPEã€‚<br>
<strong>java.io.PrintStream</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">ensureOpen</span><span style="color:#f92672">()</span> <span style="color:#66d9ef">throws</span> IOException <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>out <span style="color:#f92672">==</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span>
      <span style="color:#75715e">//æŠ›å¼‚å¸¸
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">throw</span> <span style="color:#66d9ef">new</span> IOException<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Stream closed&#34;</span><span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>

<span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">write</span><span style="color:#f92672">(</span><span style="color:#66d9ef">char</span> buf<span style="color:#f92672">[])</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">synchronized</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">this</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
      <span style="color:#75715e">//è¿™é‡Œè°ƒç”¨
</span><span style="color:#75715e"></span>      ensureOpen<span style="color:#f92672">();</span>
      textOut<span style="color:#f92672">.</span><span style="color:#a6e22e">write</span><span style="color:#f92672">(</span>buf<span style="color:#f92672">);</span>
      textOut<span style="color:#f92672">.</span><span style="color:#a6e22e">flushBuffer</span><span style="color:#f92672">();</span>
      charOut<span style="color:#f92672">.</span><span style="color:#a6e22e">flushBuffer</span><span style="color:#f92672">();</span>
      <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>autoFlush<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">for</span> <span style="color:#f92672">(</span><span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span> i <span style="color:#f92672">&lt;</span> buf<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span> i<span style="color:#f92672">++)</span>
          <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>buf<span style="color:#f92672">[</span>i<span style="color:#f92672">]</span> <span style="color:#f92672">==</span> <span style="color:#e6db74">&#39;\n&#39;</span><span style="color:#f92672">)</span>
            out<span style="color:#f92672">.</span><span style="color:#a6e22e">flush</span><span style="color:#f92672">();</span>
      <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
  <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>InterruptedIOException x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    Thread<span style="color:#f92672">.</span><span style="color:#a6e22e">currentThread</span><span style="color:#f92672">().</span><span style="color:#a6e22e">interrupt</span><span style="color:#f92672">();</span>
  <span style="color:#f92672">}</span>
  <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>IOException x<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  	<span style="color:#75715e">// catchäº†å¼‚å¸¸åäº†
</span><span style="color:#75715e"></span>    trouble <span style="color:#f92672">=</span> <span style="color:#66d9ef">true</span><span style="color:#f92672">;</span>
  <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><h3 id="32-julå’Œlogbackæœ‰æ²¡æœ‰å…³ç³»">3.2 JULå’ŒLogbackæœ‰æ²¡æœ‰å…³ç³»ï¼Ÿ</h3>
<p>ä»æˆ‘ä»¬è®¤çŸ¥å½“ä¸­ï¼Œè¿™æ˜¯ä¸¤ä¸ªæ—¥å¿—æ¡†æ¶ï¼Œä¸€ä¸ªæ˜¯jdkè‡ªå·±çš„ï¼Œä¸€ä¸ªæ˜¯åŸºäºslf4j apiçš„ç»å…¸å®ç°ã€‚è¿™ä¸¤ä¸ªæ—¥å¿—æ¡†æ¶ä¸€èµ·ä½¿ç”¨éœ€è¦jul-to-slf4jè¿›è¡Œæ¡¥æ¥ã€‚

  <p><img src="https://raw.githubusercontent.com/jxsrlsl1234/public-images/master/blogs/log_framework.png" alt="" loading="lazy" /></p>

ä½†å®é™…ä¸Šä»æºç å‘ç°ï¼Œlogbackæºç ä¸­æœ‰å’ŒJULäº¤äº’çš„é€»è¾‘ã€‚å¦‚ä¸‹ï¼š  <br>
<strong>ch.qos.logback.classic.jul.LevelChangePropagator</strong>  <br>
è¿™ä¸ªç±»æ˜¯é’ˆå¯¹Loggerçš„Levelè¢«æ”¹å˜åçš„ä¸€ä¸ªLoggerContextListenerã€‚è¿™ä¸ªListenerå®ç°äº†è¿™æ ·ä¸€ä¸ªæ–¹æ³•ã€‚</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">onLevelChange</span><span style="color:#f92672">(</span>Logger logger<span style="color:#f92672">,</span> Level level<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  propagate<span style="color:#f92672">(</span>logger<span style="color:#f92672">,</span> level<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// ä»”ç»†çœ‹çœ‹è¿™æ®µä»£ç ï¼Œå°†logbackçš„Loggerè½¬ä¸ºJULLoggeråä¿å­˜åœ¨LogManageré‡Œäº†
</span><span style="color:#75715e"></span><span style="color:#66d9ef">private</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">propagate</span><span style="color:#f92672">(</span>Logger logger<span style="color:#f92672">,</span> Level level<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  addInfo<span style="color:#f92672">(</span><span style="color:#e6db74">&#34;Propagating &#34;</span> <span style="color:#f92672">+</span> level <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; level on &#34;</span> <span style="color:#f92672">+</span> logger <span style="color:#f92672">+</span> <span style="color:#e6db74">&#34; onto the JUL framework&#34;</span><span style="color:#f92672">);</span>
  java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">logging</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Logger</span> julLogger <span style="color:#f92672">=</span> JULHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">asJULLogger</span><span style="color:#f92672">(</span>logger<span style="color:#f92672">);</span>
  <span style="color:#75715e">// prevent garbage collection of jul loggers whose level we set
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// see also http://jira.qos.ch/browse/LBCLASSIC-256
</span><span style="color:#75715e"></span>  <span style="color:#75715e">// æ³¨é‡Šè¯´æ€•è¢«åƒåœ¾å›æ”¶æ¸…ç†äº†
</span><span style="color:#75715e"></span>  julLoggerSet<span style="color:#f92672">.</span><span style="color:#a6e22e">add</span><span style="color:#f92672">(</span>julLogger<span style="color:#f92672">);</span>
  java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">logging</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Level</span> julLevel <span style="color:#f92672">=</span> JULHelper<span style="color:#f92672">.</span><span style="color:#a6e22e">asJULLevel</span><span style="color:#f92672">(</span>level<span style="color:#f92672">);</span>
  julLogger<span style="color:#f92672">.</span><span style="color:#a6e22e">setLevel</span><span style="color:#f92672">(</span>julLevel<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// logbackçš„Loggerè½¬ä¸ºJULLogger
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">public</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">logging</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Logger</span> <span style="color:#a6e22e">asJULLogger</span><span style="color:#f92672">(</span>Logger logger<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#66d9ef">return</span> asJULLogger<span style="color:#f92672">(</span>logger<span style="color:#f92672">.</span><span style="color:#a6e22e">getName</span><span style="color:#f92672">());</span>
<span style="color:#f92672">}</span>
<span style="color:#75715e">// logbackçš„Loggerè½¬ä¸ºJULLogger
</span><span style="color:#75715e"></span><span style="color:#66d9ef">static</span> <span style="color:#66d9ef">public</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">logging</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Logger</span> <span style="color:#a6e22e">asJULLogger</span><span style="color:#f92672">(</span>String loggerName<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
  <span style="color:#75715e">//å…ˆé€šè¿‡logbackçš„Loggeræ‰¾åˆ°LoggerName
</span><span style="color:#75715e"></span>  String julLoggerName <span style="color:#f92672">=</span> asJULLoggerName<span style="color:#f92672">(</span>loggerName<span style="color:#f92672">);</span>
  <span style="color:#75715e">// å†é€šè¿‡LoggerNameå»JULä¸­æ‰¾å¯¹åº”çš„Logger
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">return</span> java<span style="color:#f92672">.</span><span style="color:#a6e22e">util</span><span style="color:#f92672">.</span><span style="color:#a6e22e">logging</span><span style="color:#f92672">.</span><span style="color:#a6e22e">Logger</span><span style="color:#f92672">.</span><span style="color:#a6e22e">getLogger</span><span style="color:#f92672">(</span>julLoggerName<span style="color:#f92672">);</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>ä»¥ä¸Šé€»è¾‘æœ€é‡è¦çš„åœ¨ <strong>java.util.logging.Logger.getLogger(julLoggerName)</strong>  <br>
è¿™ä¸€æ®µä¸å°±æ˜¯ä½¿ç”¨JULè·å–Loggerçš„è¡Œä¸ºå—ï¼Ÿæ˜¯çš„ã€‚ä½†æ˜¯è¿™æ®µä»£ç é€»è¾‘å¾ˆå¤šçš„ï¼Œå…³é”®åœ¨äºå¦‚æœæ²¡è·å–åˆ°ï¼Œä¼šè‡ªåŠ¨åˆ›å»ºLoggerå¹¶ä¿å­˜åˆ° LoggerManager çš„UserLoggerContexté‡Œï¼ˆä»£ç ä¸è´´äº†ï¼‰ã€‚ <br>
æ‰€ä»¥è¯´ï¼Œå…¶å®Logbackè¿˜æ˜¯å’ŒJULè¿›è¡Œäº†ä¸€äº›ç®€å•äº¤äº’çš„ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦è¿™æ ·ï¼Œå¯ä»¥å‚è€ƒå®˜ç½‘ï¼š<a href="https://logback.qos.ch/manual/configuration.html#LevelChangePropagator" target="_blank" rel="noopener">LevelChangePropagator</a></p>

          </div>
        </div>
                 
      
  
  

  
<div class="disqus-box layout-margin content-padding-large soft-size--large soft-style--box">
    <div id="disqus_thread"></div>
    <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "personalblog-lsl" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>


  <div class="article-paging">
    
    
      <section class="post-paging--item card-container content-padding-primary soft-size--primary soft-style--box">
  <div class="card-cover" background-image-lazy data-img="https://raw.githubusercontent.com/jxsrlsl1234/public-images/master/blogs/cover1.png"></div>
  <div class="card-text">
    <a href="/blogs/springmvc%E9%A1%B9%E7%9B%AE%E4%B8%ADwebapplicationcontext%E6%98%AF%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E5%87%BA%E6%9D%A5%E7%9A%84/"><h4 class="card-text--title text-ellipsis">SpringMVCé¡¹ç›®ä¸­WebApplicationContextæ˜¯å¦‚ä½•æ„å»ºå‡ºæ¥çš„</h4></a>
    <p class="card-text--row">2022-12-22 15:50</p>
  </div>
</section>
    
  </div>
</div>
  <aside class="widget-info">
    
<section class="aside-widget widget-author content-padding-large soft-size--large soft-style--box">
  <div class="widget-body">
    <div class="author-box avatar">
      
      <img class="author-avatar soft-size--round soft-style--box" src="https://gimg2.baidu.com/image_search/src=http%3A%2F%2Flmg.jj20.com%2Fup%2Fallimg%2Ftx26%2F01080117025728.jpg&amp;refer=http%3A%2F%2Flmg.jj20.com&amp;app=2002&amp;size=f9999,10000&amp;q=a80&amp;n=0&amp;g=0n&amp;fmt=auto?sec=1672826145&amp;t=a153646188cf215f2f529313c26f70de" alt="jxsrlsl1234">
      
      <h2 class="author-name text-ellipsis">jxsrlsl1234</h2>
      
      <p class="author-desc text-ellipsis">ä¸€ä¸ªåŠªåŠ›å¥‹æ–—çš„ç¤¾ç•œ</p>
      
    </div>
  </div>
</section>


    


    






<section class="aside-widget widget-articles content-padding-large soft-size--large soft-style--box">
  <h2 class="widget-header">
    <div class="title">
      <span>Related Posts</span>
    </div>
  </h2>
  <div class="widget-body">
    <ul class="post-list">
      
      
        <li class="post-item"><a href="/blogs/springmvc%E9%A1%B9%E7%9B%AE%E4%B8%ADwebapplicationcontext%E6%98%AF%E5%A6%82%E4%BD%95%E6%9E%84%E5%BB%BA%E5%87%BA%E6%9D%A5%E7%9A%84/">SpringMVCé¡¹ç›®ä¸­WebApplicationContextæ˜¯å¦‚ä½•æ„å»ºå‡ºæ¥çš„</a></li>
      
        <li class="post-item"><a href="/blogs/%E8%87%AA%E5%AE%9A%E4%B9%89tomcat%E4%BC%98%E9%9B%85%E9%80%80%E5%87%BA%E9%80%BB%E8%BE%91/">è‡ªå®šä¹‰Tomcatä¼˜é›…é€€å‡ºé€»è¾‘</a></li>
      
    </ul>
  </div>
</section>


    




<section class="aside-widget widget-categories content-padding-large soft-size--large soft-style--box">
  <h2 class="widget-header">
    <div class="title">
      <span>Categories</span>
    </div>
  </h2>
  <div class="widget-body">
    <ul class="categories-list">
      
        <li>
          <a href="https://jxsrlsl1234.github.io/categories/java/">Java</a>
          <span>3</span>
        </li>
      
    </ul>
  </div>

  
</section>


    




<section class="aside-widget widget-tags content-padding-large soft-size--large soft-style--box">
  <h2 class="widget-header">
    <div class="title">
      <span>Tags</span>
    </div>
  </h2>
  <div class="widget-body">
    <div class="tags-list">
      
        <a href="https://jxsrlsl1234.github.io/tags/springboot/" data-count="2" class="soft-size--small soft-style--hover soft-style--active">SpringBoot</a>
      
        <a href="https://jxsrlsl1234.github.io/tags/jvm/" data-count="1" class="soft-size--small soft-style--hover soft-style--active">JVM</a>
      
        <a href="https://jxsrlsl1234.github.io/tags/sentinel/" data-count="1" class="soft-size--small soft-style--hover soft-style--active">Sentinel</a>
      
        <a href="https://jxsrlsl1234.github.io/tags/spring/" data-count="1" class="soft-size--small soft-style--hover soft-style--active">Spring</a>
      
        <a href="https://jxsrlsl1234.github.io/tags/springmvc/" data-count="1" class="soft-size--small soft-style--hover soft-style--active">SpringMVC</a>
      
        <a href="https://jxsrlsl1234.github.io/tags/tomcat/" data-count="1" class="soft-size--small soft-style--hover soft-style--active">Tomcat</a>
      
        <a href="https://jxsrlsl1234.github.io/tags/%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6/" data-count="1" class="soft-size--small soft-style--hover soft-style--active">æ—¥å¿—æ¡†æ¶</a>
      
    </div>
  </div>

  
</section>

  </aside>
</div>
  </main><footer class="footer-container layout-block">
  
  <div class="social-icons">
    
      <a class="soft-size--primary soft-style--box" href="https://github.com/jxsrlsl1234" target="_blank" rel="noopener noreferrer">
          
        <svg class="icon icon-github" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg">
          <path d="M64.6 512c0 195.6 125.4 361.9 300.1 422.9 23.5 5.9 19.9-10.8 19.9-22.2v-77.6c-135.8 15.9-141.3-74-150.5-89-18.5-31.5-61.9-39.5-49-54.5 31-15.9 62.5 4 98.9 58 26.4 39.1 77.9 32.5 104.1 26 5.7-23.5 17.9-44.5 34.7-60.9-140.7-25.2-199.4-111.1-199.4-213.3 0-49.5 16.4-95.1 48.4-131.8-20.4-60.6 1.9-112.4 4.9-120.1 58.2-5.2 118.5 41.6 123.3 45.3 33.1-8.9 70.8-13.7 112.9-13.7 42.4 0 80.3 4.9 113.5 13.9 11.3-8.6 67.3-48.8 121.4-43.9 2.9 7.7 24.7 58.3 5.5 118.1 32.5 36.8 49 82.8 49 132.4 0 102.3-59 188.3-200.2 213.2 23.5 23.3 38.1 55.5 38.1 91.1v112.7c0.8 9 0 17.9 15.1 17.9C832.7 877 960.4 709.4 960.4 512.1c0-247.5-200.6-447.9-447.9-447.9C265 64.1 64.6 264.5 64.6 512z"></path>
        </svg>
        

        

        

        

        
      </a>
    
  </div>
  

  <div class="colour-bar"></div>
  
  
  <p>Â© 2021 <a href="https://github.com/miiiku/hugo-theme-kagome">kagome</a>.</p>
  

  

  <p>
    Powered by
    <a href="https://gohugo.io/" target="_blank" rel="noopener noreferrer">Hugo</a>
    Theme - 
    <a href="https://github.com/miiiku/hugo-theme-kagome" target="_blank" rel="noopener noreferrer author">kagome</a>
  </p>

  <p>
    <a href="javascript:;" id="theme-light">ğŸŒ light</a>
    <a href="javascript:;" id="theme-dark">ğŸŒ› dark</a>
    <a href="javascript:;" id="theme-auto">ğŸ¤–ï¸ auto</a>
  </p>
</footer>








</body>

</html>