<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en-us" lang="en-us">
<head>
  <link href="https://gmpg.org/xfn/11" rel="profile">
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <meta name="generator" content="Hugo 0.87.0" />

  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <title>My New Hugo Site</title>
  <meta name="description" content="" />

  
  <link type="text/css" rel="stylesheet" href="https://jxsrlsl1234.github.io/css/print.css" media="print">
  <link type="text/css" rel="stylesheet" href="https://jxsrlsl1234.github.io/css/poole.css">
  <link type="text/css" rel="stylesheet" href="https://jxsrlsl1234.github.io/css/syntax.css">
  <link type="text/css" rel="stylesheet" href="https://jxsrlsl1234.github.io/css/hyde.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Abril+Fatface|PT+Sans:400,400i,700">


  
  <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
  <link rel="shortcut icon" href="/favicon.png">

  
  <link href="https://jxsrlsl1234.github.io/index.xml" rel="alternate" type="application/rss+xml" title="My New Hugo Site" />
  
</head>

  <body class=" ">
  <aside class="sidebar">
  <div class="container sidebar-sticky">
    <div class="sidebar-about">
      <a href="https://jxsrlsl1234.github.io/"><h1>My New Hugo Site</h1></a>
      <p class="lead">
      An elegant open source and mobile first theme for <a href="http://hugo.spf13.com">hugo</a> made by <a href="http://twitter.com/mdo">@mdo</a>. Originally made for Jekyll.
      </p>
    </div>

    <nav>
      <ul class="sidebar-nav">
        <li><a href="https://jxsrlsl1234.github.io/">Home</a> </li>
        
      </ul>
    </nav>

    <p>&copy; 2022. All rights reserved. </p>
  </div>
</aside>

    <main class="content container">
    <div class="posts">
<article class="post">
  <h1 class="post-title">
    <a href="https://jxsrlsl1234.github.io/springboot/%E8%87%AA%E5%AE%9A%E4%B9%89tomcat%E4%BC%98%E9%9B%85%E9%80%80%E5%87%BA%E9%80%BB%E8%BE%91/">自定义Tomcat优雅退出逻辑</a>
  </h1>
  <time datetime="2022-12-05T16:25:32&#43;0800" class="post-date">Mon, Dec 5, 2022</time>
  背景 SpringBoot早期版本是不支持优雅退出的，即JVM准备退出时，ShutdownHook钩子函数执行Spring context退出逻辑时，会直接把Tomcat线程池关闭，导致请求无法正常处理。 这在一些通用场景可能会出现客户端无法成功获取服务端返回数据的问题，各种5xx异常出现。
这个在后续的springboot版本中有所改观，在springboot 2.3 版本之后，支持了优雅停机的操作。
但是对于较早期版本如果想要优雅停机怎么做？
自定义Tomcat优雅停机操作 早期的springboot其实也有很多通用接口可以实现优雅停机。最简单的方法就是自定义WebServerFactoryCustomizer，然后在这个customizer中监听ContextClosedEvent事件， 在监听到该事件后，执行Tomcat线程池的优雅shutdown逻辑。以下为一种简单的开发方式。
import org.apache.catalina.connector.Connector; import org.slf4j.Logger; import org.slf4j.LoggerFactory; import org.springframework.beans.factory.annotation.Configurable; import org.springframework.boot.web.embedded.tomcat.ConfigurableTomcatWebServerFactory; import org.springframework.boot.web.embedded.tomcat.TomcatConnectorCustomizer; import org.springframework.boot.web.server.WebServerFactoryCustomizer; import org.springframework.context.ApplicationListener; import org.springframework.context.annotation.Bean; import org.springframework.context.annotation.Configuration; import org.springframework.context.event.ContextClosedEvent; import java.util.concurrent.Executor; import java.util.concurrent.ThreadPoolExecutor; import java.util.concurrent.TimeUnit; @Configuration public class TomcatShutdownConfig { @Bean public GracefulShutdown gracefulShutdown() { return new GracefulShutdown(); } @Bean public WebServerFactoryCustomizer gracefulShutdownWebServerFactoryCustomizer() { return factory -&gt; { if (factory instanceof ConfigurableTomcatWebServerFactory) { ((ConfigurableTomcatWebServerFactory) factory).addConnectorCustomizers(gracefulShutdown()); } }; } private static class GracefulShutdown implements TomcatConnectorCustomizer, ApplicationListener&lt;ContextClosedEvent&gt; { private static final Logger log = LoggerFactory.
  
  <div class="read-more-link">
    <a href="/springboot/%E8%87%AA%E5%AE%9A%E4%B9%89tomcat%E4%BC%98%E9%9B%85%E9%80%80%E5%87%BA%E9%80%BB%E8%BE%91/">Read More…</a>
  </div>
  
</article><article class="post">
  <h1 class="post-title">
    <a href="https://jxsrlsl1234.github.io/about/">About</a>
  </h1>
  <time datetime="2022-12-05T00:48:36&#43;0800" class="post-date">Mon, Dec 5, 2022</time>
  Hello, This is a hugo Page! 
  
</article>
</div>
    </main>

    
      
    
  </body>
</html>
